(executable
 (name t)
 (modules t)
 (ocamlopt_flags (:standard -linscan -Oclassic)))

(rule
 (enabled_if 
  (and (= %{context_name} "main")
       (= %{system} "linux")
       (= %{architecture} "amd64")))
 (target t.output)
 (deps t.exe)
 (action (with-outputs-to t.output (progn
    (bash "readelf -sW ./t.exe | grep \" caml_apply\" | sed \"s/.*caml_//\" | sort | uniq")
    (run ./t.exe)))))

(rule
 (alias   runtest)
 (enabled_if 
  (and (= %{context_name} "main")
       (= %{system} "linux")
       (= %{architecture} "amd64")))
 (action (diff t.expected t.output)))

;; t.ml was created using cinaps
;; (cinaps
;;  (files t.ml))
